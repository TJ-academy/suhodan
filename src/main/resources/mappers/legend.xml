<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="legend">

	<select id="list" resultType="com.example.suhodan.legend.LegendDTO">
		select * from suho_legend order by legend_id
	</select>
	
	<select id="listPaging" resultType="com.example.suhodan.legend.LegendDTO">
	    SELECT * FROM (
	        SELECT ROWNUM AS rnum, a.*
	        FROM (
	            SELECT * FROM suho_legend ORDER BY legend_id DESC
	        ) a
	        WHERE ROWNUM &lt;= #{end}
	    )
	    WHERE rnum &gt;= #{start}
	</select>
	
	<select id="getTotalCount" resultType="int">
	    SELECT COUNT(*) FROM suho_legend
	</select>

	<insert id="insert">
		insert into suho_legend (legend_id, title, story, tts_audio, img, location, reg_date, source) 
		values (suho_legend_seq.nextval, #{title}, #{story}, #{tts_audio}, #{img}, #{location}, sysdate, #{source})
	</insert>

	<update id="update">
		update suho_legend
		set title = #{title}, location = #{location}, story = #{story}, source = #{source}, img = #{img}, tts_audio = #{tts_audio}
		where legend_id = #{legend_id} 
	</update>

	<delete id="delete">
		delete from suho_legend where legend_id = #{legend_id}
	</delete>

	<select id="detail" resultType="com.example.suhodan.legend.LegendDTO">
		select * from suho_legend where legend_id=#{legend_id}
	</select>

	<select id="list_location" resultType="com.example.suhodan.legend.LegendDTO">
		select * from suho_legend
		where location like '%' || #{location} || '%'
	</select>
	
	<select id="img_file_info" resultType="String">
		select img from suho_legend where legend_id = #{legend_id}
	</select>
	
	<select id="tts_file_info" resultType="String">
		select tts_audio from suho_legend where legend_id = #{legend_id}
	</select>
	
	<select id="listPagingSearch"
		resultType="com.example.suhodan.legend.LegendDTO">
		SELECT * FROM (
		SELECT ROWNUM AS rnum, a.*
		FROM (
		SELECT * FROM suho_legend
		<where>
			<choose>
				<when test="searchType == 'title' and searchKeyword != ''">
					AND title LIKE '%' || #{searchKeyword} || '%'
				</when>
				<when test="location == 'location' and searchKeyword != ''">
					AND location LIKE '%' || #{searchKeyword} || '%'
				</when>
				<when test="searchType == 'story' and searchKeyword != ''">
					AND story LIKE '%' || #{searchKeyword} || '%'
				</when>
			</choose>
		</where>
		ORDER BY legend_id DESC  ) a
		WHERE ROWNUM &lt;= #{end}
		)
		WHERE rnum &gt;= #{start}
	</select>

	<select id="getTotalCountSearch" resultType="int">
		SELECT COUNT(*) FROM suho_legend
		<where>
			<choose>
				<when test="searchType == 'title' and searchKeyword != ''">
					AND title LIKE '%' || #{searchKeyword} || '%'
				</when>
				<when test="searchType == 'location' and searchKeyword != ''">
					AND location LIKE '%' || #{searchKeyword} || '%'
				</when>
				<when
					test="searchType == 'story' and searchKeyword != ''">
					AND story LIKE '%' || #{searchKeyword} || '%'
				</when>
			</choose>
		</where>
	</select>
	<select id="searchFromLocation" parameterType="string" resultType="com.example.suhodan.legend.SearchDonationDTO">
	    SELECT *
	    FROM (
	        SELECT 
	            l.legend_id,
	            l.title,
	            l.location AS legendLocation,
	            d.content_id AS contentId,
	            d.title AS donationTitle,
	            d.location AS donationLocation,
	            ROW_NUMBER() OVER (PARTITION BY d.title ORDER BY d.content_id) AS rn
	        FROM suho_legend l
	        JOIN suho_donation_content d
	          ON d.location = SUBSTR(l.location, INSTR(l.location, ' ') + 1)
	        WHERE l.location = #{location, jdbcType=VARCHAR}
	    )
	    WHERE rn = 1
	</select>
</mapper>