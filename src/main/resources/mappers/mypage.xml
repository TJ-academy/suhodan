<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mypage">
	<select id="getUserBadge" resultType="com.example.suhodan.member.mypage.MypageDTO">
        SELECT id userbadge_id, user_id, b.badge_id badge_id, name badge_name, description badge_desc, img badge_img, get_date
        FROM suho_userbadge ub, suho_badge b
        WHERE ub.user_id = #{user_id} and ub.badge_id = b.badge_id
        ORDER BY ub.get_date desc
    </select>
    
    <select id="getUserBadgesPaged" resultType="com.example.suhodan.member.mypage.MypageDTO">
        select * from (
        	select inner_query.*, rownum as rn
        	from (
        		SELECT id userbadge_id, user_id, b.badge_id badge_id, name badge_name, description badge_desc, img badge_img, get_date
		        FROM suho_userbadge ub, suho_badge b
		        WHERE ub.user_id = #{user_id} and 
		        	ub.badge_id = b.badge_id
		        ORDER BY ub.get_date desc
        	) inner_query
        	where rownum &lt;= #{endRow}
        )
        where rn &gt;= #{startRow}
    </select>
    
    <select id="getUserBadgeCount" resultType="int">
	    SELECT COUNT(*)
	    FROM suho_userbadge
	    WHERE user_id = #{user_id}
	</select>
    
    <select id="badgeDetail" resultType="com.example.suhodan.member.mypage.MypageDTO">
    	SELECT id userbadge_id, user_id, b.badge_id badge_id, name badge_name, description badge_desc, img badge_img, get_date
        FROM suho_userbadge ub, suho_badge b
        WHERE ub.id = #{userbadge_id} and ub.badge_id = b.badge_id
    </select>
    
    <select id="donationList" resultType="com.example.suhodan.member.mypage.MypageDTO">
		select * from (
			select inner_query.*, rownum as rn
			from (
				 SELECT
				 	c.content_id	   AS project_id,
				 	c.location		   AS location,
				    c.title            AS project_title,
				    c.content          AS project_desc,
				    c.filename		   AS project_img,
				    t.amount           AS amount,
				    t.donation_date    AS donation_date,
				    t.transaction_id transaction_id,
				    start_date, end_date, count(*) over() donation_count
				FROM donation_transaction       t
				     JOIN suho_donation_content c
				       ON c.content_id = t.content_id
				WHERE t.donor_id = #{donor_id}
				ORDER BY t.donation_date DESC
			) inner_query
			where rownum &lt;= #{endRow}
		)
		where rn &gt;= #{startRow}
    </select>
    
    <select id="donationDetail" resultType="com.example.suhodan.member.mypage.MypageDTO">
	     SELECT 
		    c.content_id	   AS project_id,
		    c.title               AS project_title,
   	     	c.filename		   	  AS project_img,
		    c.start_date          AS start_date,
		    c.end_date            AS end_date,
		    c.location            AS location,
		    t.payment_method      AS payment_method,
		    t.amount              AS amount,
		    t.donation_date       AS donation_date,
		    t.transaction_id transaction_id
	    FROM donation_transaction t
	    JOIN suho_donation_content c
	      ON t.content_id = c.content_id
	    WHERE t.transaction_id = #{transaction_id}
    </select>
    
    <select id="rewardList" resultType="com.example.suhodan.member.mypage.MypageDTO">
    	select * from (
        	select inner_query.*, rownum as rn
        	from (
        		select DONOR_ID user_id, transaction_id, dt.CONTENT_ID project_id, sdc.title project_title, sdc.FILENAME project_img, start_date, end_date, location, AMOUNT, DONATION_DATE, dt.REWARD_ID reward_id, sr.name reward_name, description reward_desc, count(*) over() reward_count
        		from donation_transaction dt, suho_reward sr, suho_donation_content sdc
        		where dt.REWARD_ID = sr.reward_id and 
        			sdc.content_id = dt.CONTENT_ID and 
        			DONOR_ID = #{user_id}
		        ORDER BY donation_date desc
        	) inner_query
        	where rownum &lt;= #{endRow}
        )
        where rn &gt;= #{startRow}
    </select>
    
    <select id="rewardDetail" resultType="com.example.suhodan.member.mypage.MypageDTO">
    	select DONOR_ID user_id, dt.TRANSACTION_ID transaction_id, dt.CONTENT_ID project_id, sdc.title project_title, sdc.FILENAME project_img, start_date, end_date, location, AMOUNT, DONATION_DATE, dt.REWARD_ID reward_id, sr.name reward_name, description reward_desc, img reward_img, goods_1, goods_2, goods_3, goods_4, sub.id userbadge_id
    	from donation_transaction dt, suho_reward sr, suho_donation_content sdc, suho_userbadge sub
    	where dt.REWARD_ID = sr.reward_id and sdc.content_id = dt.CONTENT_ID and dt.transaction_id = #{transaction_id} and dt.transaction_id = sub.transaction_id
    </select>
</mapper>